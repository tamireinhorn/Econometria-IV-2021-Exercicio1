---
title: "Exercise 1"
output: html_notebook
---
Loading packages is a must
```{r}
library(tidyverse)
library(dplyr)
library(tsibble)
library(feasts)
library(stringr)
library(lubridate)
library(anytime)
library(ggplot2)
library(ggthemes)
library(knitr)
library(kableExtra)
library(DT)
library(htmltools)
library(reshape2) #to be used with tidyverse and gglopt2
```


First of all, we need to read all the files. This is my very lousy version.
```{r}
clean_data <- function(ticker) {
  ##In this function, we're going to first convert the Date column to date:
 
     ticker$Date <- as.Date(ticker$Date, '%m/%d/%Y')

  
  ## Then, we want to restrict it from 2000 onwards
     new_ticker <- filter(ticker, format(ticker$Date, '%Y') >= 2000)
     ##We need to make the left join first to create NA for all MINUTES
     minute_list <- sort(unique(new_ticker$Time)) 
     day_list <- sort(unique(new_ticker$Date))
     minute_df <- data.frame('Time' = minute_list) ##I need a minute df
     day_df <- data.frame('Date' = day_list) ##I need a day df
     day_minute_df <- left_join(day_df, minute_df, character()) ##I create a df with all dates and all possible minutes
     new_ticker <- left_join(day_minute_df, new_ticker, by = c('Time', 'Date')) ##Then we left join this bad boy and we're DONE
     new_ticker$minute_return <- (new_ticker$Close - lag(new_ticker$Close))/ new_ticker$Close ##Return of level is p_t - p_{t-1} / p_{t-1}
     new_ticker$minute_log_return <- log(new_ticker$Close) - log(lag(new_ticker$Close)) ##Log return: log(p_t) - log(p_{t-1})
     
  return(new_ticker)
}
```

Instead of doing things manually, I conceded to a list format and decided to do things correctly:
This will import, clean and create the variables all at once. It's not fast, but was it better to wait for 3 chunks of code? Not really.
```{r}

files_list <- list.files('Data')
stock_name <- str_remove(files_list, ".txt")
stock_list <- vector(mode = "list", length = 30) ##Initialize the stock list.
for (i in 1:length(stock_list)) {
  stock_df <- data.frame(read_csv(paste('Data/',files_list[i], sep = ""), col_types = cols())) 
  clean_stock_df <- clean_data(stock_df)
  stock_list[[i]] <- clean_stock_df[,]
  
}
names(stock_list) <- stock_name
```



OK, now let's create our daily variables.

```{r}
AXP %>% group_by(Date) %>% summarise(daily=sum(minute_log_return,na.rm=T), RV = sum(minute_log_return^2, na.rm = T), VOL = sum(Volume, na.rm = T), log_RV = log(sum(minute_log_return^2, na.rm = T)) ) ##This works as intended, just creates our daily dataframe. Therefore
##I'll turn this logic into a function and create daily dataframes for all of these tickers. 
```
Seeing that my handcrafted example works, it's time to make it into a proper function to create our daily dataframes
```{r}
make_daily_data <- function(clean_ticker){
  daily_ticker <- clean_ticker %>% group_by(Date) %>% summarise(daily=sum(minute_log_return,na.rm=T), RV = sum(minute_log_return^2, na.rm = T), VOL = sum(Volume, na.rm = T), log_RV = log(sum(minute_log_return^2, na.rm = T)) )
  
  
}
```
Now, we apply this function for all tickers, just like before.
```{r}
daily_AXP <- make_daily_data(AXP)
daily_BA <-make_daily_data(BA)
daily_CAT <- make_daily_data(CAT)
daily_CSCO <- make_daily_data(CSCO)
daily_CVX <- make_daily_data(CVX)
daily_DD <-make_daily_data(DD)
daily_DIS <- make_daily_data(DIS)
daily_GE <-make_daily_data(GE)
daily_GS <-make_daily_data(GS)
daily_HD <-make_daily_data(HD)
daily_IBM <- make_daily_data(IBM)
daily_INTC <- make_daily_data(INTC)
daily_JNJ <- make_daily_data(JNJ)
daily_JPM <- make_daily_data(JPM)
daily_KO <-make_daily_data(KO)
daily_MCD <- make_daily_data(MCD)
daily_MMM <- make_daily_data(MMM)
daily_MRK <-make_daily_data(MRK)
daily_MSFT <- make_daily_data(MSFT)
daily_NKE <-make_daily_data(NKE)
daily_PFE <- make_daily_data(PFE)
daily_PG <-make_daily_data(PG)
daily_SPY <- make_daily_data(SPY)
daily_TRV <- make_daily_data(TRV)
daily_UNH <-make_daily_data(UNH)
daily_UTX <- make_daily_data(UTX)
daily_V <- make_daily_data(V)
daily_VZ <-make_daily_data(VZ)
daily_WMT <- make_daily_data(WMT)
daily_XOM <- make_daily_data(XOM)
```

Now, for a simple plot:

```{r}
ggplot(daily_AXP, aes(x= RV)) + geom_histogram(binwidth = 0.001) 
```
So maybe having multiple objects is SHITTY to plot all at once like Otavio did. Can I fix it? 

```{r}
z <- cbind(daily_AXP, daily_BA)
```


