---
title: "Exercise 1"
output: html_notebook
---
Loading packages is a must
```{r}
library(tidyverse)
library(dplyr)
library(tsibble)
library(feasts)
library(stringr)
library(lubridate)
library(anytime)
library(ggplot2)
library(ggthemes)
library(knitr)
library(kableExtra)
library(DT)
library(htmltools)
library(reshape2) #to be used with tidyverse and gglopt2
library(ggpubr)
```


First of all, we need to read all the files. This is my very lousy version.
```{r}
clean_data <- function(ticker) {
  ##In this function, we're going to first convert the Date column to date:
 
     ticker$Date <- as.Date(ticker$Date, '%m/%d/%Y')

  
  ## Then, we want to restrict it from 2000 onwards
     new_ticker <- filter(ticker, format(ticker$Date, '%Y') >= 2000)
     ##We need to make the left join first to create NA for all MINUTES
     minute_list <- sort(unique(new_ticker$Time)) 
     day_list <- sort(unique(new_ticker$Date))
     minute_df <- data.frame('Time' = minute_list) ##I need a minute df
     day_df <- data.frame('Date' = day_list) ##I need a day df
     day_minute_df <- left_join(day_df, minute_df, character()) ##I create a df with all dates and all possible minutes
     new_ticker <- left_join(day_minute_df, new_ticker, by = c('Time', 'Date')) ##Then we left join this bad boy and we're DONE
     new_ticker$minute_return <- (new_ticker$Close - lag(new_ticker$Close))/ new_ticker$Close ##Return of level is p_t - p_{t-1} / p_{t-1}
     new_ticker$minute_log_return <- log(new_ticker$Close) - log(lag(new_ticker$Close)) ##Log return: log(p_t) - log(p_{t-1})
     
  return(new_ticker)
}
```

Instead of doing things manually, I conceded to a list format and decided to do things correctly:
This will import, clean and create the variables all at once. It's not fast, but was it better to wait for 3 chunks of code? Not really.
```{r}

files_list <- list.files('Data')
stock_name <- str_remove(files_list, ".txt")
stock_list <- vector(mode = "list", length = 30) ##Initialize the stock list.
for (i in 1:length(stock_list)) {
  stock_df <- data.frame(read_csv(paste('Data/',files_list[i], sep = ""), col_types = cols())) 
  clean_stock_df <- clean_data(stock_df)
  stock_list[[i]] <- clean_stock_df[,]
  
}
names(stock_list) <- stock_name
```



OK, now let's create our daily variables.

```{r}
AXP %>% group_by(Date) %>% summarise(daily=sum(minute_log_return,na.rm=T), RV = sum(minute_log_return^2, na.rm = T), VOL = sum(Volume, na.rm = T), log_RV = log(sum(minute_log_return^2, na.rm = T)) ) ##This works as intended, just creates our daily dataframe. Therefore
##I'll turn this logic into a function and create daily dataframes for all of these tickers. 
```
Seeing that my handcrafted example works, it's time to make it into a proper function to create our daily dataframes
```{r}
make_daily_data <- function(clean_ticker){
  daily_ticker <- clean_ticker %>% group_by(Date) %>% summarise(daily=sum(minute_log_return,na.rm=T), RV = sum(minute_log_return^2, na.rm = T), VOL = sum(Volume, na.rm = T), log_RV = log(sum(minute_log_return^2, na.rm = T)) )
  
  
}
```
Now, we apply this function for all tickers, just like before.
```{r}
daily_stock_list <- vector(mode = 'list', length = 30) ##Initialize the daily stock list.
for (i in 1:length(stock_list)) {

  daily_stock_df <- make_daily_data(stock_list[[i]])
  daily_stock_list[[i]] <- daily_stock_df[,]
  
}
names(daily_stock_list) <- stock_name
```

Now, for a simple plot:

```{r}
plot_list<- vector(mode = 'list', length = 30)
for(stock in daily_stock_list){
 #plot <- ggplot(stock, aes(x = RV)) + geom_histogram(bins = 100) +labs(title = paste("RV Histogram for ", stock_name[stock],sep = ""))
 plot_list[stock] <- plot
}

```
Testing out this package that groups graphs. 
```{r}
data("ToothGrowth")
head(ToothGrowth)
mtcars$name <- rownames(mtcars)
mtcars$cyl <- as.factor(mtcars$cyl)
bxp <- ggboxplot(ToothGrowth, x = "dose", y = "len",
                 color = "dose", palette = "jco") + labs(title = 'bolinh')

# Dot plot (dp)
dp <- ggdotplot(ToothGrowth, x = "dose", y = "len",
                 color = "dose", palette = "jco", binwidth = 1)
bp <- ggbarplot(mtcars, x = "name", y = "mpg",
          fill = "cyl",               # change fill color by cyl
          color = "white",            # Set bar border colors to white
          palette = "jco",            # jco journal color palett. see ?ggpar
          sort.val = "asc",           # Sort the value in ascending order
          sort.by.groups = TRUE,      # Sort inside each group
          x.text.angle = 90           # Rotate vertically x axis texts
          )

# Scatter plots (sp)
sp <- ggscatter(mtcars, x = "wt", y = "mpg",
                add = "reg.line",               # Add regression line
                conf.int = TRUE,                # Add confidence interval
                color = "cyl", palette = "jco", # Color by groups "cyl"
                shape = "cyl"                   # Change point shape by groups "cyl"
                )+
  stat_cor(aes(color = cyl), label.x = 3)       # Add correlation coefficient
ggarrange(bxp, dp, bp + rremove("x.text"), 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2)
```
sss
```{r}
plot_list <- vector(mode = 'list', length = length(daily_stock_list))
for(i in 1:length(daily_stock_list)){
  title <- paste("RV Histogram for", stock_name[i])
  normal <- data.frame('Normal' = rnorm(n = nrow(daily_stock_list[[i]]), mean = mean(daily_stock_list[[i]]$RV), sd = sd(daily_stock_list[[i]]$RV)))
  plot <- ggplot(data = daily_stock_list[[i]], aes(x = RV)) + labs(x = 'RV %', title = title, y= "") + geom_histogram(bins = 100) +
    geom_line(data = normal)
  plot_list[[i]] <- plot
}

```
Let's try plotting them all together
```{r}
#ggarrange(plotlist = plot_list, ncol = 5, nrow = 3)
qplot(dnorm(daily_stock_list[[i]]$RV, mean = mean(daily_stock_list[[i]]$RV), sd = sd(daily_stock_list[[i]]$RV)))
normal <- data.frame(dnorm(n = nrow(daily_stock_list[[i]]), mean = mean(daily_stock_list[[i]]$RV), sd = sd(daily_stock_list[[i]]$RV)))
ggplot(normal, aes(x = Normal)) + geom_line()
```


