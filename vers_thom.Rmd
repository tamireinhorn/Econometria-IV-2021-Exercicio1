---
title: "Exercise 1"
output: html_notebook
fig_width: 6 
fig_height: 4 
---

## **1. LOADING PACKAGES**

```{r}
library(tidyverse)
library(HARModel)
library(dplyr)
library(tsibble)
library(feasts)
library(stringr)
library(lubridate)
library(anytime)
library(ggplot2)
library(ggthemes)
library(knitr)
library(kableExtra)
library(DT)
library(htmltools)
library(reshape2) #to be used with tidyverse and gglopt2
library(ggpubr)
```

## **2. DATA PREPARATION**

The function clean_data will be created to clean the files, and it will be applied in the second chunk of the code, in which we will import the files.

```{r}
clean_data <- function(ticker) {

  ##In this function, we're going to first convert the Date column to date:
 
     ticker$Date <- as.Date(ticker$Date, '%m/%d/%Y')
  
  ## Then, we want to restrict it from 2000 onwards

     new_ticker <- filter(ticker, format(ticker$Date, '%Y') >= 2000)

     ##We need all days to contain the same number ofminutes, so we will use the left_join command first ensure that, and also to create NA for all MINUTES for which certain stocks do not have data.
     
     minute_list <- sort(unique(new_ticker$Time)) 
     day_list <- sort(unique(new_ticker$Date))
     minute_df <- data.frame('Time' = minute_list) ##A minute df is needed for the left_join() to be applied
     day_df <- data.frame('Date' = day_list) ##A day df is needed for the left_join() to be applied
     day_minute_df <- left_join(day_df, minute_df, character()) ##A df is created in which all 390 possible minutes were joined into each possible day
     new_ticker <- left_join(day_minute_df, new_ticker, by = c('Time', 'Date')) ##Then we left join all the informations in the new ticker into the day_minute df, uniformising all dates for all stocks in number of minutes
     new_ticker$minute_return <- (new_ticker$Close - lag(new_ticker$Close))/ new_ticker$Close ##Return taken on levels: p_t - p_{t-1} / p_{t-1}
     new_ticker$minute_log_return <- log(new_ticker$Close) - log(lag(new_ticker$Close)) ##Log return: log(p_t) - log(p_{t-1})
     
  return(new_ticker)
}
```

Given the clean_data() function above, we will now jointly import and clean the data (alternatively, we could have importer everything, then created the cleaning function and then have applied it, using three different chunks). 


```{r}
files_list <- list.files('Data')
stock_name <- str_remove(files_list, ".txt")
stock_list <- vector(mode = "list", length = 30) ##Initialize the stock list.
for (i in 1:length(stock_list)) {
  stock_df <- data.frame(read_csv(paste('Data/',files_list[i], sep = ""), col_types = cols())) 
  clean_stock_df <- clean_data(stock_df)
  stock_list[[i]] <- clean_stock_df[,]
}

names(stock_list) <- stock_name
```

A function to compute daily variables of interest will be created, and in a following code it will be applied to our list of stocks. These variables of interest are the realized volatility, sum of daily minute returns and sum of daily volumes traded per minute:

```{r}

#First for AXP, to understand the logic
#AXP %>% group_by(Date) %>% summarise(daily=sum(minute_log_return,na.rm=T), RV = sum(minute_log_return^2, na.rm = T), VOL = sum(Volume, na.rm = T), log_RV = log(sum(minute_log_return^2, na.rm = T)) ) ##This works as intended, just creates our daily dataframe. Therefore

##This logic will be turned into a function that creates daily dataframes for all of the tickers

make_daily_data <- function(clean_ticker){
  daily_ticker <- clean_ticker %>% group_by(Date) %>% summarise(daily=sum(minute_log_return,na.rm=T), RV = sum(minute_log_return^2, na.rm = T), VOL = sum(Volume, na.rm = T), log_RV = log(sum(minute_log_return^2, na.rm = T)) )
  #return(daily_ticker)
}
```

Now, we apply this function for all tickers, just like before.

```{r}
daily_stock_list <- vector(mode = 'list', length = 30) ##Initialize the daily stock list.

for (i in 1:length(stock_list)) {

  daily_stock_df <- make_daily_data(stock_list[[i]])
  daily_stock_list[[i]] <- daily_stock_df[,]
  
}
names(daily_stock_list) <- stock_name
```

As suggested, we should try creating one giant dataframe in order to use facet_wrap and plot everything at once.

```{r}
complete_daily_df <- bind_rows(daily_stock_list, .id = "column_label")
##I just want the name to be Stock:
names(complete_daily_df)[names(complete_daily_df)== 'column_label'] <- 'Stock'
```

## **3. PLOTS**

**Histogram of RV:**

```{r fig.height = 30, fig.width = 14}
ggplot(complete_daily_df, aes(x = RV)) +
  geom_histogram(aes(y = ..density..),binwidth = 0.0001, color = "darkblue", fill = "lightblue") + 
  labs(title = "RV Histograms", x = "", y = "")   + xlim(0, 0.01) +  facet_wrap(~ Stock, ncol = 3) +
  theme_minimal()
```

**Histogram of log RV:**

```{r fig.height = 30, fig.width = 14}

ggplot(complete_daily_df, aes(x = log_RV)) +
  geom_histogram(aes(y = ..density..),binwidth = 0.0001, color = "darkblue", fill = "lightblue") + 
  labs(title = "log(RV) Histograms", x = "", y = "")   + xlim(0, 0.01) +  facet_wrap(~ Stock, ncol = 3) +
  theme_minimal()

```

**Time Series of RV**

```{r fig.height = 30, fig.width = 14}

#test <- complete_daily_df %>%
#        filter(Stock=="AXP")
#ggplot(test,aes(x=Date, y=100*RV))+geom_line

  plot <- ggplot(complete_daily_df, aes(x = Date, y= 100*RV)) +
  geom_line(size=1) +
  facet_wrap(~ Stock, ncol = 4, scales = 'free') +
  labs(x = "", y = "", title = 'RV Time Series (in percentage terms, %)') +
  theme_bw() + theme(legend.position = "none")

  plot
 

```

**Time Series of log_RV**

```{r fig.height = 30, fig.width = 14}

  plot_log_RV <- ggplot(complete_daily_df, aes(x = Date, y= 100*log_RV)) +
  geom_line(size=1) +
  facet_wrap(~ Stock, ncol = 4, scales = 'free') +
  labs(x = "", y = "", title = 'log(RV) Time Series (in percentage terms, %)') +
  theme_bw() + theme(legend.position = "none")

  plot_log_RV
```

**AUTOCORRELATION** :

We will use function ACF from the feasts package, which requires data in question to be converted to a tstibble. This allows us to more easily manipulate time series objects that are usually dealt with in other classes.

**ACF for RV**:

```{r fig.height = 40, fig.width = 14}

RV_tsibble <- complete_daily_df %>% select(Stock, Date, RV) %>%  as_tsibble(key = 'Stock', index = 'Date', regular = FALSE)

RV_tsibble %>% ACF(RV, lag_max = 200) %>% autoplot() + theme_bw() + labs(x = 'Lags', y = '')

#estimating an AR(1) process for RV of stock AXP:
#RV_AXP <- RV_tsibble %>% filter(Stock == "AXP")
#RV_AXP_AR1 <- arima(RV_AXP$RV , order = c(1, 0, 0))



```

**ACF for log_RV**

```{r fig.height = 40, fig.width = 14}

log_RV_tsibble <- complete_daily_df %>% select(Stock, Date, log_RV) %>%  as_tsibble(key = 'Stock', index = 'Date', regular = FALSE)

log_RV_tsibble %>% ACF(log_RV, lag_max = 200) %>% autoplot() + theme_bw() + labs(x = 'Lags', y = '')

```

Looking at the ACF for both RV and log(RV), it is easy to notice that the plots present an approximate linear decay, whereas theoretical autoregressive processes contain ACFs that decay exponentially. 

**3. BENCHMARK MODEL**

We will now conduct an estimation of a HAR Model for the realized volatility for each Stock in our sample. With the estimated coefficients, we will simulate a HAR process in order to obtain a theoretical ACF and compare it with the empirical one.

```{R}

#Below we group the data (in tsibble format) by stock, and estimate the HAR model for each stock, using tidyverse`s feature group_map() and the HARestimate function.

har_est <- RV_tsibble %>% 
  group_by(Stock) %>%
  group_map(.tbl=RV_tsibble$RV, .f = ~HAREstimate(RM = RV_tsibble$RV, periods = c(1,5,22)) )

#extracting the estimated coefficients and simulating theoretical processes: We can do these tasks through a for_loop, or group_map() in tidyverse.

#for_loop

har_simulations <- vector(mode="list", length=30)

for (i in 1:30) {
  har_simulations[i] <- paste("har_simulation",stock_name[i], sep="_" )
  har_simulations[[i]] <- HARSimulate(len=1500, periods = c(1, 5, 22), coef=coef(har_est[[i]]), errorTermSD = 0.001)   
  #colocar nÃºmero certo de dias (contar quantos dias cada stock tem?)
}

#tidyverse: tentar

#generating and plotting ACFs describing the data simulated in the above.
#tentar via tidyverse pra usar face_wrap

har_acf <- vector(mode="list", length=30)
for (i in 1:30) {
  har_acf[i] <- paste("har_acf",stock_name[i], sep="_" )
  har_acf[[i]] <- acf(har_simulations[[i]], lag.max = 200)
  plot(har_acf[[i]])
}


```
