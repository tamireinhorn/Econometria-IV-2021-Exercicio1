---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 


Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

INTRODUCTION

2. DATA PREPARATION

2.1 LOADING PREVIOUSLY INSTALLED PACKAGES

```{r}
library(tidyverse)
library(tsibble)
library(feasts)
library(stringr)
library(lubridate)
library(anytime)
library(ggplot2)
library(ggthemes)
library(knitr)
library(kableExtra)
library(DT)
library(htmltools)
library(reshape2) #to be used with tidyverse and gglopt2
```

2.2 IMPORTING AND CLEANING THE DATA

```{r}

#creating a list with names of all files 
files_list <- list.files('Data')
stock_name <- str_remove(files_list, ".txt")

#A list will be created to store each company`s observations as dataframes 

stocks_list <- lapply(files_list, function(x) read.table(paste("Data/",x,sep = ""), header=T, sep = ",")) 
stocks_list <- mapply(cbind, stocks_list, "Stock" = stock_name, SIMPLIFY=F)

# A dataframe will bind "rowwise" the dataframes stored in stocks_list 
df <-  do.call("rbind", stocks_list)

# From the above dataframe we will convert the date column and only keep observations starting in 2000
clean_df <- df %>% select(Asset, Date, Time, Close, Volume) %>%
    mutate(Time = sprintf( "%04d", as.numeric(Time))) %>% #?
    mutate(Time = str_replace(Time, "(?=\\d{2}$)", ":")) %>% #?
    mutate(Date = as.Date(df$Date, format = "%m / %d / %Y")) %>% 
    filter(Date >= as.Date("2000-01-01")) 

```

2.3 INSPECTING OBSERVATIONS

For each stock, the number of observations will be given:

```{R}
count <- clean_df %>% group_by(Stock) %>% summarise(n = n(Stock))

datatable(count, 
          width = "30%", 
          caption = 'Number of observations by Stock')
```

The level of the last closing price for each day, by asset, will be plotted:

```{R}
clean_df %>% group_by(Stock, Date) %>% 
  filter(Time == max(Time)) %>% 
  ggplot(aes(x = as.Date(Date), y = Close)) +
  geom_line() +
  facet_wrap(~ Stock, ncol = 4, scales = 'free') + 
  labs(x = "", y = "", title = 'Daily close prices') +
  theme_bw()

#facet_wrap from ggplot allows plotting the filtered observations (closing price evolving through the last minute of each day) in different graphs (one for each stock), with four columns per row

```
3. DESCRIPTIVE ANALYSIS

3.1 ASSESSING VOLATILITY
```{r}

#An object rv will be created, containing volumes and close_to_close returns

rv <- clean_data %>% 
  
  group_by(Stock, Date) %>% #formulas below will be applied for the same stock between dates 
  
  mutate(r_cc = log(Close) - lag(log(Close))) %>% #this creates a column where, for a stock at a certain minute of a day, the rate of change of the closing price with respect to that price in the previous minute is returned?
  
  summarise(RV = sum(r_cc^2, na.rm = T), VOL = sum(Volume)) %>% #for each stock and day we obtain the accumulated squared returns and volume of the minutes of that day
  
  ungroup() #Avoids potential unintended errors due to the grouping

#we use dcast() to take a look in the RV. LHS variable values will be in rows. RHS variables values will become column names. fun.aggregate(value.var) will be cell values. datatable() is then a table made to contain values from dcast()
#dcast() is a long-to-wide reshapping tool, while melt() is wide-to-long

rv_wide <- rv %>% select(Stock, Date, RV) %>% dcast(Date ~ Stock, value.var = 'RV')

datatable(cbind(Date = rv_wide[,1], round(RV_wide[,2:30],5)), #we round the numbers to contain 5 digits
          
          width = "100%", 
          caption = 'Daily Realized Volatility',
          options = list(scrollX = T))
```